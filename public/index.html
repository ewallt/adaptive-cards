<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #app-container {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 4rem);
        }
        #page-viewport { width: 100%; overflow: visible; }
        #kb-container { display: block; }
        .kb-card { margin-bottom: 2rem; }
        .step-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; flex-shrink: 0; }
        .control-button { padding: 0.5rem 1.25rem; border-radius: 9999px; font-weight: 600; transition: all 0.2s ease-in-out; border: 2px solid transparent; }
        .control-button.active { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .theme-button.active { color: white; }
        .control-button.inactive { background-color: #f1f5f9; color: #334155; }
        .control-button.inactive:hover { background-color: #e2e8f0; }
        .topic-switcher, .library-switcher { padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 600; border: 1px solid #d1d5db; max-width: 100%; }
        .library-switcher { margin-bottom: 1rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-gray-900 dark:text-gray-100">

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 w-full">
        <header class="text-center mb-8">
            <h1 id="main-title" class="text-3xl font-bold text-slate-900 tracking-tight sm:text-4xl dark:text-gray-100">Knowledge Base</h1>
            <div id="library-switcher-container" class="mt-4"></div>
            <div id="topic-switcher-container" class="mt-2"></div>
        </header>

        <div class="flex flex-col sm:flex-row justify-center items-center gap-6 my-6 flex-wrap">
            <div id="theme-switcher" class="flex items-center gap-2 p-1 bg-slate-200 rounded-full dark:bg-gray-800">
                <button data-theme="blue" class="theme-button control-button">Blue</button>
                <button data-theme="green" class="theme-button control-button">Green</button>
                <button data-theme="indigo" class="theme-button control-button">Indigo</button>
                <button data-theme="dark" class="theme-button control-button">Dark</button>
            </div>
        </div>

        <div id="page-viewport" class="flex-grow">
            <div id="kb-container"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- STATE MANAGEMENT ---
            let masterLibrary = null;
            let sortedLibraryIds = null;
            let sortedTopicIds = null;
            let currentLibraryId = null;
            let currentTopicId = null;
            let currentTheme = 'blue';

            // --- THEME DEFINITIONS ---
            const themes = {
                blue: { accentBg: 'bg-blue-600', accentText: 'text-blue-800', accentBgLight: 'bg-blue-50', accentBorder: 'border-blue-500' },
                green: { accentBg: 'bg-green-700', accentText: 'text-green-800', accentBgLight: 'bg-green-50', accentBorder: 'border-green-600' },
                indigo: { accentBg: 'bg-indigo-600', accentText: 'text-indigo-800', accentBgLight: 'bg-indigo-50', accentBorder: 'border-indigo-500' },
                dark: { accentBg: 'bg-gray-800', accentText: 'text-gray-100', accentBgLight: 'bg-gray-900', accentBorder: 'border-gray-600' }
            };

            // --- DOM ELEMENT REFERENCES ---
            const appContainer = document.getElementById('app-container');
            const container = document.getElementById('kb-container');
            const mainTitleEl = document.getElementById('main-title');
            const themeSwitcher = document.getElementById('theme-switcher');
            const librarySwitcherContainer = document.getElementById('library-switcher-container');
            const topicSwitcherContainer = document.getElementById('topic-switcher-container');

            // --- DETECTION FUNCTION ---
            function looksLikeKnowledgeBaseFormat(obj) {
                // Check if this looks like a Knowledge Base topic object
                return obj && typeof obj === 'object' && 
                       obj.knowledgeBase && 
                       obj.knowledgeBase.entryPoints;
            }

            // --- RENDER FUNCTIONS ---
            function renderApp() {
                if (!masterLibrary || !currentLibraryId) return;
                const currentLibrary = masterLibrary[currentLibraryId];
                if (!currentLibrary) return;
                
                sortedTopicIds = Object.keys(currentLibrary).sort((a, b) => {
                    const orderA = currentLibrary[a].knowledgeBase?.display_order || 0;
                    const orderB = currentLibrary[b].knowledgeBase?.display_order || 0;
                    return orderA - orderB;
                });
                
                if (!currentTopicId || !currentLibrary[currentTopicId]) {
                    currentTopicId = sortedTopicIds[0];
                }
                
                const topicData = currentLibrary[currentTopicId].knowledgeBase;
                if (!topicData) return;
                
                document.title = topicData.pageTitle || topicData.title || 'Knowledge Base';
                mainTitleEl.textContent = topicData.title || 'Knowledge Base';

                buildLibrarySwitcher();
                buildTopicSwitcher();
                renderContent(topicData);
            }

            function buildLibrarySwitcher() {
                if (!sortedLibraryIds || sortedLibraryIds.length <= 1) {
                    librarySwitcherContainer.innerHTML = '';
                    return;
                }
                
                let html = '<select id="library-switcher" class="library-switcher dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100">';
                sortedLibraryIds.forEach(libraryId => {
                    const displayName = libraryId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const isSelected = libraryId === currentLibraryId ? 'selected' : '';
                    html += `<option value="${libraryId}" ${isSelected}>${displayName}</option>`;
                });
                html += '</select>';
                librarySwitcherContainer.innerHTML = html;
                document.getElementById('library-switcher').addEventListener('change', handleLibraryChange);
            }

            function buildTopicSwitcher() {
                let html = '<select id="topic-switcher" class="topic-switcher dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100">';
                sortedTopicIds.forEach(topicId => {
                    const topic = masterLibrary[currentLibraryId][topicId].knowledgeBase;
                    const isSelected = topicId === currentTopicId ? 'selected' : '';
                    html += `<option value="${topicId}" ${isSelected}>${topic.title}</option>`;
                });
                html += '</select>';
                topicSwitcherContainer.innerHTML = html;
                document.getElementById('topic-switcher').addEventListener('change', handleTopicChange);
            }
            
            function renderContent(topicData) {
                container.innerHTML = '';
                if (!topicData.entryPoints) return;
                
                topicData.entryPoints.sort((a,b) => a.step - b.step).forEach(entry => {
                    const cardHTML = `
                        <div class="kb-card p-2">
                            <div class="bg-white rounded-xl shadow-md flex-grow flex flex-col h-full dark:bg-gray-800">
                                <div class="card-content-wrapper p-6 sm:p-8">
                                    <div class="flex items-start sm:items-center space-x-4 mb-4">
                                        <div class="step-circle themable-accent-bg">${entry.step}</div>
                                        <h2 class="text-2xl font-bold text-slate-900 dark:text-gray-100">${entry.title}</h2>
                                    </div>
                                    <p class="themable-accent-text themable-accent-bg-light text-lg font-semibold p-4 rounded-lg mb-6">${entry.corePrinciple}</p>
                                    <p class="text-slate-600 leading-relaxed mb-6 dark:text-gray-300">${entry.development}</p>
                                    ${(entry.scriptureReferences && entry.scriptureReferences.length > 0) ? entry.scriptureReferences.map(ref => `
                                        <div class="bg-slate-100 border-l-4 border-slate-400 p-4 rounded-r-lg mb-4 dark:bg-gray-700 dark:border-slate-500">
                                            <p class="font-bold text-slate-800 dark:text-gray-200">${ref.citation}</p>
                                            <p class="italic text-slate-700 mt-1 dark:text-gray-300">"${ref.text}"</p>
                                            <p class="text-sm text-slate-600 mt-2 dark:text-gray-300">${ref.relevance}</p>
                                        </div>
                                    `).join('') : ''}
                                    ${entry.keyQuote ? `
                                        <blockquote class="themable-accent-border border-l-4 pl-4 py-2 my-6">
                                            <p class="text-lg italic text-slate-700 font-medium dark:text-gray-300">"${entry.keyQuote}"</p>
                                        </blockquote>
                                    ` : ''}
                                </div>
                            </div>
                        </div>`;
                    container.innerHTML += cardHTML;
                });
                applyThemeAccentColors(currentTheme);
            }

            function applyThemeAccentColors(themeName) {
                currentTheme = themeName;
                localStorage.setItem('knowledgeBaseTheme', themeName);
                const theme = themes[themeName];
                if (themeName === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                document.querySelectorAll('.themable-accent-bg').forEach(el => { 
                    el.className = el.className.replace(/bg-\w+-\d+/g, '') + ' ' + theme.accentBg; 
                });
                document.querySelectorAll('.themable-accent-text').forEach(el => { 
                    el.className = el.className.replace(/text-\w+-\d+/g, '') + ' ' + theme.accentText; 
                });
                document.querySelectorAll('.themable-accent-bg-light').forEach(el => { 
                    el.className = el.className.replace(/bg-\w+-\d+/g, '') + ' ' + theme.accentBgLight; 
                });
                document.querySelectorAll('.themable-accent-border').forEach(el => { 
                    el.className = el.className.replace(/border-\w+-\d+/g, '') + ' ' + theme.accentBorder; 
                });
                themeSwitcher.querySelectorAll('.theme-button').forEach(button => {
                    const buttonTheme = button.dataset.theme;
                    button.classList.remove('active', ...Object.values(themes).map(t => t.accentBg));
                    button.classList.add('inactive');
                    if (buttonTheme === themeName) {
                        button.classList.remove('inactive');
                        button.classList.add('active', theme.accentBg);
                    }
                });
            }

            // --- EVENT HANDLERS ---
            function handleLibraryChange(e) {
                currentLibraryId = e.target.value;
                localStorage.setItem('knowledgeBaseLibraryId', currentLibraryId);
                currentTopicId = null; 
                renderApp();
            }

            function handleTopicChange(e) {
                currentTopicId = e.target.value;
                renderApp();
            }
            
            themeSwitcher.addEventListener('click', (e) => { 
                if (e.target.matches('.theme-button')) {
                    applyThemeAccentColors(e.target.dataset.theme);
                }
            });

            // --- INITIALIZE ---
            async function initializeApp() {
                try {
                    const savedTheme = localStorage.getItem('knowledgeBaseTheme') || 'blue';
                    applyThemeAccentColors(savedTheme);
                    
                    const response = await fetch('./data/content.json'); 
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const raw = await response.json();

                    // Detect if this is single library (Knowledge Base format) or multi-library
                    const topKeys = Object.keys(raw);
                    if (topKeys.length === 0) throw new Error('content.json is empty.');

                    const firstVal = raw[topKeys[0]];
                    const isSingleLibrary = looksLikeKnowledgeBaseFormat(firstVal);

                    if (isSingleLibrary) {
                        // Single library mode - wrap in a container
                        masterLibrary = { 'default': raw };
                        sortedLibraryIds = ['default'];
                        currentLibraryId = 'default';
                    } else {
                        // Multi-library mode
                        masterLibrary = raw;
                        sortedLibraryIds = Object.keys(masterLibrary).sort();
                        const savedLib = localStorage.getItem('knowledgeBaseLibraryId');
                        currentLibraryId = (savedLib && masterLibrary[savedLib]) ? savedLib : sortedLibraryIds[0];
                    }

                    renderApp();
                } catch (error) {
                    console.error("Failed to load content:", error);
                    appContainer.innerHTML = `<div class="text-center p-8 bg-red-100 text-red-700 rounded-lg"><h3 class="font-bold text-lg">An error occurred</h3><p>Could not load content from ./data/content.json. Please ensure the file exists and is accessible.</p></div>`;
                }
            }
            
            initializeApp();
        });
    </script>
</body>
</html>